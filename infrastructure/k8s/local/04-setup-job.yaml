apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-setup-script
  namespace: cloudscribe
data:
  setup.sh: |
    #!/bin/bash
    set -e
    set -x

    KEYCLOAK_URL="http://keycloak-service:8080"
    KCADM="/opt/keycloak/bin/kcadm.sh"
    
    echo "â³ Waiting for Keycloak..."
    until $KCADM config credentials --server $KEYCLOAK_URL --realm master --user "$KEYCLOAK_ADMIN" --password "$KEYCLOAK_ADMIN_PASSWORD" > /dev/null 2>&1; do
      sleep 5
    done

    echo "âœ… Keycloak Ready. Starting configuration..."

    # 1. Realm
    if ! $KCADM get realms/cloudscribe > /dev/null 2>&1; then
        $KCADM create realms -s realm=cloudscribe -s enabled=true -s accessTokenLifespan=3600
    fi

    # Get client ID if exists
    CLIENT_ID=$($KCADM get clients -r cloudscribe -q clientId=cloudscribe-web --fields id --format csv --noquotes 2>/dev/null | tail -1)

    if [ -z "$CLIENT_ID" ]; then
        echo "Creating new client..."
        $KCADM create clients -r cloudscribe \
          -s clientId=cloudscribe-web \
          -s secret=$OIDC_CLIENT_SECRET \
          -s enabled=true \
          -s clientAuthenticatorType=client-secret \
          -s "redirectUris=[\"http://localhost:7234/signin-oidc\",\"https://localhost:7234/signin-oidc\",\"http://localhost:5000/signin-oidc\"]" \
          -s 'attributes={"post.logout.redirect.uris":"http://localhost:7234/signout-callback-oidc##https://localhost:7234/signout-callback-oidc"}' \
          -s "webOrigins=[\"+\"]" \
          -s publicClient=false \
          -s serviceAccountsEnabled=true \
          -s standardFlowEnabled=true \
          -s directAccessGrantsEnabled=true
    else
        echo "Updating existing client $CLIENT_ID..."
        $KCADM update clients/$CLIENT_ID -r cloudscribe \
          -s "redirectUris=[\"http://localhost:7234/signin-oidc\",\"https://localhost:7234/signin-oidc\",\"http://localhost:5000/signin-oidc\"]" \
          -s 'attributes={"post.logout.redirect.uris":"http://localhost:7234/signout-callback-oidc##https://localhost:7234/signout-callback-oidc"}'
    fi

    # 3. User
    if ! $KCADM get users -r cloudscribe -q username=testuser | grep "testuser" > /dev/null; then
        $KCADM create users -r cloudscribe -s username=testuser -s enabled=true
        $KCADM set-password -r cloudscribe --username testuser --new-password test
    fi

    echo "ðŸŽ‰ K8S CONFIGURATION FINISHED"
    
---
apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-setup
  namespace: cloudscribe
spec:
  template:
    spec:
      containers:
        - name: setup
          image: quay.io/keycloak/keycloak:24.0.1
          command: ["/bin/bash", "/opt/scripts/setup.sh"]
          env:
            - name: KEYCLOAK_ADMIN
              valueFrom:
                secretKeyRef:
                  name: cloudscribe-secrets
                  key: keycloak-admin-user
            - name: KEYCLOAK_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: cloudscribe-secrets
                  key: keycloak-admin-pass
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: cloudscribe-secrets
                  key: oidc-client-secret
          volumeMounts:
            - name: script-volume
              mountPath: /opt/scripts
      volumes:
        - name: script-volume
          configMap:
            name: keycloak-setup-script
            defaultMode: 0777
      restartPolicy: OnFailure